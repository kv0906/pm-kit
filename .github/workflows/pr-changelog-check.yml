name: PR Changelog Check

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]
    branches: [main]

permissions:
  pull-requests: read

jobs:
  changelog-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Changelog Entry section in PR body
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          if [ -z "${PR_BODY}" ]; then
            echo "PR body is empty. Add a ## Changelog Entry section."
            exit 1
          fi

          SECTION=$(printf '%s\n' "$PR_BODY" | awk '
            BEGIN { in_section=0 }
            /^## Changelog Entry[[:space:]]*$/ { in_section=1; next }
            /^## / { if (in_section) exit; in_section=0 }
            in_section { print }
          ' | sed '/^[[:space:]]*$/d')

          if [ -z "$SECTION" ]; then
            echo "Missing or empty ## Changelog Entry section in PR body."
            exit 1
          fi

          if printf '%s\n' "$SECTION" | grep -qiE '^(todo|tbd|n/?a|none|\[.*\])$'; then
            echo "## Changelog Entry content looks like a placeholder. Replace it with a real summary."
            exit 1
          fi

          echo "Changelog entry section is present and non-empty."
